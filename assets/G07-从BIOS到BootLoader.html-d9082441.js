import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as n,c as d,a as e,b as a,e as c,d as r}from"./app-cdabc73c.js";const t="/assets/a4009d3de2dbae10340256af2737c26a-b53a7e3e.jpeg",p="/assets/13187b1ffe878bc406da53967e8cddb7-03eccd23.png",i="/assets/5f364ef5c9d1a3b1d9bb7153bd166bfc-a2856b01.jpeg",l="/assets/2900bed28c7345e6c90437da8a5cd563-ee9001dc.jpeg",m="/assets/image-20220705204400694-7fce3eb8.png",b="data:image/png;base64,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",u="/assets/2b8573bbbf31fc0cb0420e32d07b196a-4da199d6.jpeg",g="/assets/image-20220705204954184-f8005201.png",h="/assets/0a29c1d3e1a53b2523d2dcab3a59886b-551183f0.jpeg",k={},M=r('<h1 id="_07-从bios到bootloader-创业伊始-有活儿老板自己上" tabindex="-1"><a class="header-anchor" href="#_07-从bios到bootloader-创业伊始-有活儿老板自己上" aria-hidden="true">#</a> 07 | 从BIOS到bootloader：创业伊始，有活儿老板自己上</h1><p>有了开放的营商环境，咱们外包公司的创业之旅就要开始了。</p><p>上一节我们说，x86 作为一个开放的营商环境，有两种模式，一种模式是<code>实模式</code>，只能寻址 1M，每个段最多 64K。这个太小了，相当于咱们创业的个体户模式。有了项目只能老板自己上，本小利微，万事开头难。另一种是<code>保护模式</code>，对于 32 位系统，能够寻址 4G。这就是大买卖了，老板要雇佣很多人接项目。</p><p>几乎所有成功的公司，都是从个体户模式发展壮大的，因此，这一节咱们就从系统刚刚启动的个体户模式开始说起。</p><h2 id="bios基本输入输出系统-创业指导手册" tabindex="-1"><a class="header-anchor" href="#bios基本输入输出系统-创业指导手册" aria-hidden="true">#</a> BIOS基本输入输出系统: 创业指导手册</h2><p>当你轻轻按下计算机的启动按钮时，你的主板就加上电了。</p><p>按照我们之前说的，这时候你的 CPU 应该开始执行指令了。你作为老板，同时也作为员工，要开始干活了。可是你发现，这个时候还没有项目执行计划书，所以你没啥可干的。</p><p>也就是说，<code>这个时候没有操作系统，内存也是空的，一穷二白。</code>CPU 该怎么办呢？</p><p>你作为这个创业公司的老板，由于原来没开过公司，对于公司的运营当然是一脸懵的。但是我们有一个良好的营商环境，其中的<code>创业指导中心</code>早就考虑到这种情况了。于是，创业指导中心就给了你<code>一套创业公司启动指导手册</code>。你只要按着指导手册来干就行了。</p><img src="'+t+'" alt="img" style="zoom:25%;"><p>计算机系统也早有计划。在主板上，有一个东西叫 <strong><mark>ROM</mark></strong>（Read Only Memory，<code>只读存储器</code>）。这和咱们平常说的内存 <strong><mark>RAM</mark></strong>（Random Access Memory，<code>随机存取存储器</code>）不同。</p><p>咱们平时买的内存条是可读可写的，这样才能保存计算结果。<code>而 ROM 是只读的，上面早就固化了一些初始化的程序</code>，也就是 <strong><code>BIOS</code></strong>（Basic Input and Output System，<code>基本输入输出系统</code>）。</p><p>如果你自己安装过操作系统，刚启动的时候，按某个组合键，显示器会弹出一个蓝色的界面。能够调整启动顺序的系统，就是我说的 BIOS，然后我们就可以先执行它。</p><img src="'+p+'" alt="img" style="zoom:67%;"><p>创业初期，你的办公室肯定很小。假如现在你有 1M 的内存地址空间。这个空间非常有限，你需要好好利用才行。</p><img src="'+i+'" alt="img" style="zoom:25%;"><p>在 x86 系统中，将 1M 空间最上面的 0xF0000 到 0xFFFFF 这 64K 映射给 <mark>ROM 只读存储器</mark>，也就是说，到这部分地址访问的时候，会访问 ROM。</p><p>当电脑刚加电的时候，会做一些重置的工作，将 <mark>CS <strong>代码段寄存器</strong></mark> 设置为 0xFFFF，将 <mark>IP 指令指针寄存器</mark> 设置为 0x0000，所以<code>第一条指令</code>就会指向 0xFFFF0，正是在 ROM 的范围内。在这里，有一个 <code>JMP 命令</code>会跳到 ROM 中做初始化工作的代码，于是，BIOS 开始进<code>行初始化的工作</code>。</p><blockquote><p>ROM 是只读的，上面早就固化了一些初始化的程序。例如BIOS</p></blockquote><ol><li><p>创业指导手册第一条，BIOS 要检查一下系统的硬件是不是都好着呢。</p></li><li><p>创业指导手册第二条，要有个办事大厅，只不过自己就是办事员。这个时期你能提供的服务很简单，但也会有零星的客户来提要求。</p></li></ol><p>这个时候，要建立一个<code>中断向量表</code>和<code>中断服务程序</code>，因为现在你还要用键盘和鼠标，这些都要通过中断进行的。</p><p>这个时期也要给客户输出一些结果，因为需要你自己来，所以你还要充当客户对接人(<code>输入设备驱动</code>)。你做了什么工作，做到了什么程度，都要主动显示给客户(<code>输出设备驱动</code>)，也就是在内存空间映射显存的空间，在显示器上显示一些字符。</p><img src="'+l+'" alt="img" style="zoom:25%;"><p>最后，<code>政府领进门，创业靠个人</code>。接下来就是你发挥聪明才智的时候了。</p><img src="'+m+`" alt="image-20220705204400694" style="zoom:15%;"><h2 id="bootloader-时期" tabindex="-1"><a class="header-anchor" href="#bootloader-时期" aria-hidden="true">#</a> bootloader 时期</h2><p>政府给的创业指导手册只能保证你把公司成立起来，但是公司如何做大做强，需要你自己有一套经营方法。你可以试着从档案库里面翻翻，看哪里能够找到<code>《企业经营宝典》</code>。通过这个宝典，可以帮你建立一套完整的档案库管理体系，使得任何项目的档案查询都十分方便。</p><p>现在，什么线索都没有的 BIOS，做完自己的事情，只能从档案库门卫开始，慢慢打听操作系统的下落。</p><h3 id="启动盘-引导设备的引导扇区" tabindex="-1"><a class="header-anchor" href="#启动盘-引导设备的引导扇区" aria-hidden="true">#</a> 启动盘: 引导设备的引导扇区</h3><p>操作系统在哪儿呢？一般都会在安装在<code>硬盘</code>上，在 BIOS 的界面上。你会看到一个<code>启动盘的选项</code>。启动盘有什么特点呢？它一般在<code>第一个扇区</code>，占 <code>512 字节</code>，而且<code>以 0xAA55 结束</code>。</p><blockquote><p>这是一个约定，当满足这个条件的时候，就说明这是一个启动盘，在 512 字节以内会启动相关的代码。</p></blockquote><h3 id="加载-grub" tabindex="-1"><a class="header-anchor" href="#加载-grub" aria-hidden="true">#</a> 加载 GRUB</h3><p>这些代码是谁放在这里的呢？在 Linux 里面有一个工具，叫 <strong><code>Grub2</code></strong>，全称 Grand Unified Bootloader Version 2。顾名思义，<code>就是搞系统启动的</code>。</p><p>你可以通过 <code>grub2-mkconfig -o /boot/grub2/grub.cfg</code> 来配置系统启动的选项。你可以看到里面有类似这样的配置。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>menuentry <span class="token string">&#39;CentOS Linux (3.10.0-862.el7.x86_64) 7 (Core)&#39;</span> <span class="token parameter variable">--class</span> centos <span class="token parameter variable">--class</span> gnu-linux <span class="token parameter variable">--class</span> gnu <span class="token parameter variable">--class</span> os <span class="token parameter variable">--unrestricted</span> <span class="token variable">$menuentry_id_option</span> <span class="token string">&#39;gnulinux-3.10.0-862.el7.x86_64-advanced-b1aceb95-6b9e-464a-a589-bed66220ebee&#39;</span> <span class="token punctuation">{</span>
  load_video
  <span class="token builtin class-name">set</span> <span class="token assign-left variable">gfxpayload</span><span class="token operator">=</span>keep
  insmod gzio
  insmod part_msdos
  insmod ext2
  <span class="token builtin class-name">set</span> <span class="token assign-left variable">root</span><span class="token operator">=</span><span class="token string">&#39;hd0,msdos1&#39;</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> x<span class="token variable">$feature_platform_search_hint</span> <span class="token operator">=</span> xy <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    search --no-floppy --fs-uuid <span class="token parameter variable">--set</span><span class="token operator">=</span>root <span class="token parameter variable">--hint</span><span class="token operator">=</span><span class="token string">&#39;hd0,msdos1&#39;</span>  b1aceb95-6b9e-464a-a589-bed66220ebee
  <span class="token keyword">else</span>
    search --no-floppy --fs-uuid <span class="token parameter variable">--set</span><span class="token operator">=</span>root b1aceb95-6b9e-464a-a589-bed66220ebee
  <span class="token keyword">fi</span>
  linux16 /boot/vmlinuz-3.10.0-862.el7.x86_64 <span class="token assign-left variable">root</span><span class="token operator">=</span>UUID<span class="token operator">=</span>b1aceb95-6b9e-464a-a589-bed66220ebee ro <span class="token assign-left variable">console</span><span class="token operator">=</span>tty0 <span class="token assign-left variable">console</span><span class="token operator">=</span>ttyS0,115200 <span class="token assign-left variable">crashkernel</span><span class="token operator">=</span>auto <span class="token assign-left variable">net.ifnames</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">biosdevname</span><span class="token operator">=</span><span class="token number">0</span> rhgb quiet 
  initrd16 /boot/initramfs-3.10.0-862.el7.x86_64.img
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里面的选项会在系统启动的时候，成为一个列表，让你选择从哪个系统启动。最终显示出来的结果就是下面这张图。至于上面选项的具体意思，我们后面再说。</p><img src="`+b+'" alt="img" style="zoom:50%;"><p>使用 <code>grub2-install /dev/sda</code>，可以将启动程序安装到相应的位置。</p><h3 id="grub-boot-img-core-img" tabindex="-1"><a class="header-anchor" href="#grub-boot-img-core-img" aria-hidden="true">#</a> GRUB: boot.img + core.img</h3><p>grub2 第一个要安装的就是 <code>boot.img</code>。它由 boot.S 编译而成，一共 512 字节，正式安装到启动盘的第一个扇区。这个扇区通常称为 <mark><strong>MBR</strong>（Master Boot Record，主引导记录 / 扇区）</mark>。</p><p>BIOS 完成任务后，会将 boot.img 从硬盘加载到内存中的 0x7c00 <code>来运行</code>。</p><p>由于 512 个字节实在有限，boot.img <code>做不了太多的事情</code>。它能做的最重要的一个事情就是加载 grub2 的另一个镜像 <code>core.img</code>。</p><blockquote><p><code>引导扇区</code>就是你找到的<code>门卫</code>，虽然他看着档案库的大门，但是知道的事情很少。他不知道你的宝典在哪里，但是，他知道应该问谁。门卫说，档案库入口处有个<code>管理处</code>，然后把你领到门口。</p></blockquote><p><code>core.img</code> 就是<code>管理处</code>，它们知道的和能做的事情就多了一些。core.img 由 <code>lzma_decompress.img、diskboot.img、kernel.img</code> 和<code>一系列的模块</code>组成，功能比较丰富，能做很多事情。</p><img src="'+u+'" alt="img" style="zoom:20%;"><img src="'+g+'" alt="image-20220705204954184" style="zoom:15%;"><p><code>boot.img</code> 先加载的是 <code>core.img</code> 的<code>第一个扇区</code>。如果从<code>硬盘</code>启动的话，这个扇区里面是 <code>diskboot.img</code>，对应的代码是 <code>diskboot.S</code>。</p><p>boot.img 将控制权交给 diskboot.img 后，<code>diskboot.img</code> 的任务就是将 <code>core.img</code> 的其他部分加载进来，</p><ol><li>先是<code>解压缩程序 lzma_decompress.img</code>，</li><li>再往下是 <code>kernel.img</code>，</li><li>最后是<code>各个模块 module 对应的映像</code>。 <ul><li>这里需要注意，它不是 Linux 的内核，而是 grub 的内核。</li><li>lzma_decompress.img 对应的代码是 startup_raw.S，本来 kernel.img 是压缩过的，现在执行的时候，需要解压缩。</li></ul></li></ol><p>在这之前，我们所有遇到过的程序都非常非常小，完全可以在实模式下运行，但是随着我们加载的东西越来越大，实模式这 1M 的地址空间实在放不下了，所以在真正的解压缩之前，<code>lzma_decompress.img</code> 做了一个重要的决定，就是调用 <code>real_to_prot</code>，切换到<code>保护模式</code>，这样就能在更大的寻址空间里面，加载更多的东西。</p><blockquote><p>实模式只有 1MB 内存寻址空间(X86)</p><p>加电, 重置 CS 为 0xFFFF , IP 为 0x0000, 对应 BIOS 程序</p><p>0xF0000-0xFFFFF 映射到 BIOS 程序(存储在ROM中), BIOS 做以下三件事:</p><ul><li>检查硬件</li><li>提供基本输入(中断)输出(显存映射)服务</li><li>加载 MBR 到内存(0x7c00)</li></ul><p>MRB: 启动盘第一个扇区(512B, 由 Grub2 写入 boot.img 镜像)</p><p>boot.img 加载 Grub2 的 core.img 镜像</p><p>core.img 包括 diskboot.img, lzma_decompress.img, kernel.img 以及其他模块</p><p>boot.img 先加载运行 diskboot.img, 再由 diskboot.img 加载 core.img 的其他内容</p><p>diskboot.img 加载运行解压缩程序 lzma_compress.img, 由lzma_compress.img 切换到保护模式</p><p>切换到保护模式需要做以下三件事:</p><ul><li>启用分段, 辅助进程管理</li><li>启动分页, 辅助内存管理</li><li>打开其他地址线</li></ul><p>lzma_compress.img 解压运行 grub 内核 kernel.img, kernel.img 做以下四件事:</p><ul><li>解析 grub.conf 文件</li><li>选择操作系统</li><li>例如选择 linux16, 会先读取内核头部数据进行检查, 检查通过后加载完整系统内核</li><li>启动系统内核</li></ul></blockquote><h2 id="从实模式切换到保护模式" tabindex="-1"><a class="header-anchor" href="#从实模式切换到保护模式" aria-hidden="true">#</a> 从实模式切换到保护模式</h2><p>好了，管理处听说你要找宝典，知道你将来是要做老板的人。既然是老板，早晚都要雇人干活的。这不是个体户小打小闹，所以，<code>你需要切换到老板角色</code>，进入保护模式了，<code>把哪些是你的权限，哪些是你可以授权给别人的，都分得清清楚楚</code>。</p><p>切换到保护模式要干很多工作，大部分工作都与内存的访问方式有关。</p><h3 id="建立分段-进程-分页-内存-虚拟化前提" tabindex="-1"><a class="header-anchor" href="#建立分段-进程-分页-内存-虚拟化前提" aria-hidden="true">#</a> 建立分段(进程)分页(内存) &amp; 虚拟化前提</h3><p>第一项是**<code>启用分段</code>**，就是在内存里面建立段描述符表，将寄存器里面的段寄存器变成段选择子，指向某个段描述符，这样就能实现不同进程的切换了。</p><p>第二项是**<code>启动分页</code>**。能够管理的内存变大了，就需要将内存分成相等大小的块，这些我们放到内存那一节详细再讲。</p><h3 id="划清界限-集权与授权-内核的必要性" tabindex="-1"><a class="header-anchor" href="#划清界限-集权与授权-内核的必要性" aria-hidden="true">#</a> 划清界限 &amp; 集权与授权 &amp; 内核的必要性</h3><p>切换到了老板角色，也是为了招聘很多人，<code>同时接多个项目</code>，这时候就需要<code>划清界限</code>，懂得<code>集权与授权</code>。</p><h3 id="_1-打开地址线-扩大空间" tabindex="-1"><a class="header-anchor" href="#_1-打开地址线-扩大空间" aria-hidden="true">#</a> 1. 打开地址线 -&gt; 扩大空间</h3><p>当了老板，眼界要宽多了，同理保护模式需要做一项工作，那就是打开 Gate A20，也就是第 21 根地址线的控制线。在实模式 8086 下面，一共就 20 个地址线，可访问 1M 的地址空间。如果超过了这个限度怎么办呢？当然是绕回来了。在保护模式下，第 21 根要起作用了，于是我们就需要打开 Gate A20。</p><p>切换保护模式的函数 <code>DATA32 call real_to_prot</code> 会打开 Gate A20，也就是第 21 根地址线的控制线。</p><h3 id="_2-解压缩内核-权限管理" tabindex="-1"><a class="header-anchor" href="#_2-解压缩内核-权限管理" aria-hidden="true">#</a> 2. 解压缩内核 -&gt; 权限管理</h3><p>现在好了，有的是空间了。接下来我们要对压缩过的 <code>kernel.img</code> 进行解压缩，然后跳转到 kernel.img 开始运行。</p><p>切换到了老板角色，你可以正大光明地进入档案馆，寻找你的那本宝典。</p><p>kernel.img 对应的代码是 startup.S 以及一堆 c 文件，在 startup.S 中会调用 grub_main，这是 <code>grub kernel</code> 的主函数。</p><p>在这个函数里面，<code>grub_load_config()</code> 开始解析，我们上面写的那个 grub.conf 文件里的配置信息。</p><p>如果是正常启动，grub_main 最后会调用 <code>grub_command_execute (“normal”, 0, 0)</code>，最终会调用 grub_normal_execute() 函数。在这个函数里面，grub_show_menu() 会显示出让你选择的那个操作系统的列表。</p><h3 id="_3-升级为操作系统-开始企业级经营" tabindex="-1"><a class="header-anchor" href="#_3-升级为操作系统-开始企业级经营" aria-hidden="true">#</a> 3. 升级为操作系统 -&gt; 开始企业级经营</h3><p>同理，作为老板，你发现<code>这类的宝典不止一本，经营企业的方式也有很多种</code>，到底是人性化的，还是强纪律的，这个时候你要做一个选择。</p><p>一旦，你选定了某个宝典，启动某个操作系统，就要开始调用 <code>grub_menu_execute_entry()</code> ，开始解析并执行你选择的那一项。接下来你的经营企业之路就此打开了。</p><p>例如里面的 linux16 命令，表示装载指定的内核文件，并传递内核启动参数。于是 grub_cmd_linux() 函数会被调用，它会首先读取 Linux 内核镜像头部的一些数据结构，放到内存中的数据结构来，进行检查。如果检查通过，则会读取整个 Linux 内核镜像到内存。</p><p>如果配置文件里面还有 initrd 命令，用于为即将启动的内核传递 init ramdisk 路径。于是 grub_cmd_initrd() 函数会被调用，将 initramfs 加载到内存中来。</p><p>当这些事情做完之后，<code>grub_command_execute (“boot”, 0, 0)</code> 才开始真正地启动内核。</p><h2 id="总结时刻" tabindex="-1"><a class="header-anchor" href="#总结时刻" aria-hidden="true">#</a> 总结时刻</h2><p>启动的过程比较复杂，我这里画一个图，让你比较形象地理解这个过程。你可以根据我讲的，自己来梳理一遍这个过程，做到不管是从流程还是细节上，都能心中有数。</p><img src="'+h+'" alt="img" style="zoom:25%;"><h2 id="课堂练习" tabindex="-1"><a class="header-anchor" href="#课堂练习" aria-hidden="true">#</a> 课堂练习</h2><p>grub2 是一个非常牛的 Linux 启动管理器，请你研究一下 grub2 的命令和配置，并试试通过它启动 Ubuntu 和 centOS 两个操作系统。</p><p>欢迎留言和我分享你的疑惑和见解，也欢迎你收藏本节内容，反复研读。你也可以把今天的内容分享给你的朋友，和他一起学习、进步。</p><h2 id="课后讨论" tabindex="-1"><a class="header-anchor" href="#课后讨论" aria-hidden="true">#</a> 课后讨论</h2><p>《一个64位操作系统的设计与实现》</p><p>《从实模式到保护模式》</p>',83),f={href:"https://github.com/chyyuu/ucore_os_lab",target:"_blank",rel:"noopener noreferrer"},x=e("p",null,"老师，从BIOS到bootloader，最后到保护模式，你说的这是计算机的发展过程还是，说比如我自己的电脑，每次启动都会经历从BIOS到bootloader，最后到保护模式? 作者回复: 每次启动都是。",-1);function y(z,v){const A=s("ExternalLinkIcon");return n(),d("div",null,[M,e("p",null,[a("大家有兴趣实践的话可以参考清华大学的操作系统实验课，里面第一个实验讲的就是启动的过程，可以让人理解的更加透彻。"),e("a",f,[a("https://github.com/chyyuu/ucore_os_lab"),c(A)])]),x])}const Z=o(k,[["render",y],["__file","G07-从BIOS到BootLoader.html.vue"]]);export{Z as default};
